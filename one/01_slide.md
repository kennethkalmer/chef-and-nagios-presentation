!SLIDE center
# Chef & Nagios

## Ruby on Beer, Gauteng, ZA

### Kenneth Kalmer

* [@kennethkalmer](http://twitter.com/kennethkalmer)
* <http://www.opensourcery.co.za>

!SLIDE center

### This presentation assumes familiarity with Chef and Nagios

!SLIDE center bullets

# Ohai Chef

* Awesome infrastructure automation tool
* Works great at scale
* Extremely powerful search interface
* Pure Ruby
* [Chef wiki](http://wiki.opscode.com/display/chef)

!SLIDE center bullets

# Ohai Nagios

* Defacto service monitoring tool
* Sucks at scale
* Configurations go stale if not actively maintained
* [Nagios website](http://nagios.org)

!SLIDE center bullets small

# Problems

* Infrastructure monitoring is usually "after the fact"
* Someone else's problem to configure Nagios
* Need to deploy custom plugins for NRPE
* Needs to happen as servers are provisioned

!SLIDE bullets

# Solutions

* Nagios server uses chef node database to build and maintain service checks
* Chef client maintains custom NRPE checks

!SLIDE bullets

# Sample code

* hub clone [kennethkalmer/chef-nagios](http://github.com/kennethkalmer/chef-nagios)

!SLIDE smbullets

# nagios::server

* Uses chef node database to dynamically generate nagios checks
* Uses chef data bags to extend monitoring to non-chef hosts
* Easily deploy commands and plugins to the nagios server
* Cleans up host configurations not needed any more

!SLIDE smaller

# nagios::server recipe

	@@@ ruby
	# Legacy nagios checks
	directory "/etc/nagios/objects/hosts" do
	  owner "nagios"
	  group "nagios"
	  mode 00750
	  recursive true
	end

	# Chef clients
	directory "/etc/nagios/objects/chef-hosts" do
	  owner "nagios"
	  group "nagios"
	  mode 00750
	  recursive true
	end

!SLIDE smaller

	@@@ ruby
	# Get a list of all files we currently have...
	configs = Dir['/etc/nagios/objects/chef-hosts/*.cfg'].map { |path| 
	  File.basename(path) 
	}

!SLIDE smaller

	@@@ ruby
	# Build our configs from nrpe stuff
	search( :node, 'run_list:"recipe[nagios::nrpe]"' ).each do |server|
	  next if server['nrpe'].nil?

	  template "/etc/nagios/objects/chef-hosts/#{server['fqdn']}.cfg" do
	    source "nagios-host.cfg.erb"
	    owner "nagios"
	    group "nagios"
	    mode 0640
	    variables( :server => server )
	    notifies :reload, resources(:service => 'nagios')
	  end

	  # We know this host, remove out our list
	  configs.delete( "#{server['fqdn']}.cfg" )
	end

!SLIDE smaller

	@@@ ruby
	# Now clear any stale configs
	configs.each do |old_server|
	  file "/etc/nagios/objects/chef-hosts/#{old_server}" do
	    action :delete
	    backup 1
	    notifies :reload, resources(:service => 'nagios')
	  end
	end

!SLIDE smaller

# nagios::server host template

	@@@ erb
	# Dynamically generated by chef for <%= @node[:fqdn] %>

	define host {
	  use linux-server
	  host_name <%= @server['fqdn'] %>
	  alias <%= @server['fqdn'].gsub('.example.com', '') %>
	  address <%= @server['nrpe']['address'] %>
	  check_command <%= @server['nrpe']['host_check_command'] %>
	}
	
!SLIDE smaller

	@@@ erb
	...
	
	define service {
	  use generic-service
	  host_name <%= @server['fqdn'] %>
	  service_description Current Users
	  check_command check_nrpe!check_users
	}
	
	...

!SLIDE smaller

	@@@ erb
	...
	
	<% @server['nrpe']['file_systems'].keys.each do |fs| -%>
	define service {
	  use generic-service
	  host_name <%= @server['fqdn'] %>
	  service_description Partition <%= fs %>
	  check_command check_nrpe!check_<%= fs %>
	}
	<% end -%>
	
	...

!SLIDE smaller

	@@@ erb
	...
	
	<% if @server.run_list.any? { |entry| entry =~ /ssh::server/ } -%>
	define service {
	  use generic-service
	  host_name <%= @server['fqdn'] %>
	  service_description SSH
	  check_command check_ssh!-p <%= @server['sshd']['port'] %>
	}
	<% end -%>
	
	...
	
!SLIDE smaller

	@@@ erb
	...
	
	<% @server['nrpe']['additional_commands'].each do |cmd| -%>
	define service {
	  use generic-service
	  host_name <%= @server['fqdn'] %>
	  service_description NRPE <%= cmd %>
	  check_command check_nrpe!<%= cmd %>
	}
	<% end -%>
	
	...

!SLIDE bullets

# nagios::server recap

* Standard nagios host checks
* Filesystem health from chef-client data
* Building service checks from run lists
* Node specific NRPE checks

!SLIDE bullets

# nagios::nrpe

* Install local plugins for NRPE
* Dynamically configure NRPE checks for local resources (disks, memory, load, etc)

!SLIDE smaller

# nagios::nrpe recipe

	@@@ ruby
	# Populate the filesystem list if needed
	if node[:nrpe][:file_systems].empty?
	  node[:nrpe][:file_systems] = 
		node[:filesystem].inject({}) do |list, (name, data)|
	    # Only check these types
	    if %w( ext3 ext2 xfs nfs ).include?( data[:fs_type] )
	      list[ name.split(':').last.gsub('/','_') ] = {
	        :mount => data[:mount],
	        :warning => '20%',
	        :critical => '10%'
	      }
	    end

	    list
	  end
	end

!SLIDE smaller

	@@@ ruby
	# Calculate node memory
	node[:nrpe][:mem_warn] ||= ( 
		node[:memory][:total].to_i / 1024 * 0.25 
		).to_i
	node[:nrpe][:mem_crit] ||= ( 
		node[:memory][:total].to_i / 1024 * 0.10 
		).to_i
	
	# IP address for checks
	node[:nrpe][:address] ||= node[:ipaddress]
	
!SLIDE smaller

# nagios::nrpe nrpe configuration

	@@@ ruby
	# Stock config
	template "/etc/nagios/nrpe.cfg" do
	  source "nrpe.cfg.erb"
	  owner "nagios"
	  group "nagios"
	  mode 0640
	  notifies :restart, resources(:service => 'nrpe')
	  supports :restart => true
	end

	# Magic directory for injecting other checks into
	directory "/etc/nagios/nrpe.d" do
	  owner "nagios"
	  group "nagios"
	  mode 00750
	end

!SLIDE smaller

# nagios::nrpe nrpe plugin

	@@@ ruby
	remote_file "/usr/lib/nagios/plugins/check_mem.sh" do
	  source "check_mem.sh"
	  owner "nagios"
	  group "nagios"
	  mode 0755
	  notifies :restart, resources(:service => 'nrpe'), :delayed
	end

!SLIDE smaller

# nrpe_command resource

	@@@ ruby
	include_recipe "nagios::nrpe"
	nrpe_command "check_mysql_slave"

!SLIDE bullets

# nrpe_command resource

* Inspired by runit_service
* Sets up additional nrpe checks on nagios server

!SLIDE bullets small

# Conclusions

* Chef is powerful, because of Ruby
* Nagios is powerful, enabled by Ruby
* Learning curve is worth the results
* This presentation barely touches on what is possible
* Again, this presentation assumes familiarity with Chef & Nagios

!SLIDE bullets smaller

# Thank you

* [@kennethkalmer](http://twitter.com/kennethkalmer)
* <http://opensourcery.co.za>
* Rate this talk on [SpeakerRate](http://speakerrate.com/talks/3354-nagios-chef)
* <http://chef-and-nagios.heroku.com>
* <http://github.com/kennethkalmer/chef-and-nagios-presentation>